 <!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>UFO Sightings by Country (Absolute)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #vis{max-width:1100px;margin:32px auto;padding:0 16px}
    footer{max-width:1100px;margin:0 auto 28px;padding:0 16px;font-size:12px;color:#475569}
  </style>
</head>
<body>
<div id="vis"></div>
<footer>
  Data: UFO sighting reports (compiled); Map: Natural Earth. Absolute counts shown (consider per-million in report).
</footer>

<script>
const spec = {
  $schema: "https://vega.github.io/schema/vega-lite/v5.json",
  width: 980,
  height: 560,
  title: {text: "UFO Sightings by Country (Absolute Counts)", anchor: "start"},
  projection: {type: "robinson"},

  // Start from your CSV, then aggregate to country counts
  data: { url: "scrubbed.csv" },

  transform: [
    // Uppercase the CSV two-letter code to match Natural Earth ISO codes
    { calculate: "toUpper(datum.country || '')", as: "country_upper" },

    // Aggregate counts by country code
    { aggregate: [{op: "count", as: "sightings"}], groupby: ["country_upper"] },

    // Lookup geometry by ISO_A2
    {
      lookup: "country_upper",
      from: {
        data: { url: "ne_110m_admin_0_countries.json", format: { type: "geojson" } },
        key: "properties.ISO_A2",
        fields: ["geometry","properties.NAME"]
      },
      as: ["geom1","name1"]
    },

    // Fallback lookup by ISO_A2_EH (some NE builds use this)
    {
      lookup: "country_upper",
      from: {
        data: { url: "ne_110m_admin_0_countries.json", format: { type: "geojson" } },
        key: "properties.ISO_A2_EH",
        fields: ["geometry","properties.NAME"]
      },
      as: ["geom2","name2"]
    },

    // Choose whichever geometry/name matched
    { calculate: "datum.geom1 ? datum.geom1 : datum.geom2", as: "geom" },
    { calculate: "datum.name1 ? datum.name1 : datum.name2", as: "country_name" }
  ],

  layer: [
    { data: { graticule: { step: [20, 20] } },
      mark: { type: "geoshape", filled: false, stroke: "#d7d7d7", strokeWidth: 0.5 }
    },
    {
      mark: { type: "geoshape" },
      encoding: {
        shape: { field: "geom" },
        color: {
          field: "sightings", type: "quantitative",
          scale: { scheme: "blues" },
          legend: { title: "Sightings" }
        },
        tooltip: [
          { field: "country_name", title: "Country" },
          { field: "country_upper", title: "ISO A2" },
          { field: "sightings", title: "Sightings" }
        ]
      }
    },
    { mark: { type: "geoshape", filled: false, stroke: "#8e97a3", strokeWidth: 0.7 }, encoding: { shape: { field: "geom" } } }
  ]
};

vegaEmbed("#vis", spec, { actions: false });
</script>
</body>
</html>

